@inject ISnackbar _snackbar
@inject IUserCaller _userCaller
@inject ILocalStorageService _localStorageService
@inject NavigationManager _navigationManager

<MudCarouselItem Transition="Transition.Slide">
    <MudCardHeader Class="justify-center">
        <CardHeaderAvatar>
            <MudIcon Icon="@Icons.Filled.Login" Size="Size.Large" />
        </CardHeaderAvatar>
        <CardHeaderContent>
            <MudText Typo="Typo.h5">ورود</MudText>
        </CardHeaderContent>
        <CardHeaderActions>
            <MudButton Class="mt-2" Variant="Variant.Text" OnClick="NextCarouseAction.Invoke">ثبت نام کنید</MudButton>
        </CardHeaderActions>
    </MudCardHeader>
    <MudDivider DividerType="DividerType.Middle" />

    <MudForm @ref="_form" @bind-IsValid="_isSuccess" @bind-Errors="_errors" Model="_model">
        <MudCardContent>
            <MudRTLProvider RightToLeft="false">

                <MudTextField @bind-Value="_model.UserName"
                              Validation="@(_modelValidator.ValidateValue)"
                              For="@(() => _model.UserName)"
                              Immediate="true"
                              Label="نام کاربری" />

                <MudTextField @bind-Value="_model.Password"
                              Validation="@(_modelValidator.ValidateValue)"
                              For="@(() => _model.Password)"
                              Immediate="true"
                              Label="رمز عبور"
                              InputType="InputType.Password" />

            </MudRTLProvider>
        </MudCardContent>
        <MudDivider DividerType="DividerType.Middle" Class="mt-2" />

        <MudCardActions Class="mt-2">
            <MudButton Color="Color.Primary" Variant="Variant.Filled" Disabled="!_isSuccess" OnClick="Login">ورود</MudButton>
        </MudCardActions>
    </MudForm>
</MudCarouselItem>

@code {
    [Parameter, EditorRequired]
    public Action NextCarouseAction { get; set; } = null!;

    private MudForm _form = new();
    private bool _isSuccess = false;
    private string[] _errors = { };

    private LoginDto _model = new();
    private LoginDtoFluentValidator _modelValidator = new();


    private async void Login()
    {
        await _form.Validate();
        if (_isSuccess)
        {
            var result = await _userCaller.Login(_model);
            if (result.StatusCode == HttpStatusCode.OK)
            {
                await HandleSuccessResult(result);
            }
            else if (result.StatusCode == HttpStatusCode.BadRequest)
            {
                var content = await result.Content.ReadFromJsonAsync<ValidationResult>();
                if (content != null)
                {
                    _snackbar.AddErrorList(content.Errors.Select(p => p.ErrorMessage));
                }
            }
            else
            {
                _snackbar.AddUnknownError();
            }
        }
    }

    private async Task HandleSuccessResult(HttpResponseMessage responseMessage)
    {
        var content = await responseMessage.Content.ReadFromJsonAsync<DbResponse<string, LoginError>>();
        if (content == null)
        {
            _snackbar.AddUnknownError();
            return;
        }

        if (content.Success && content.Value != null)
        {
            _snackbar.Add("ورود با موفقیت انجام شد.", Severity.Success);
            await _localStorageService.SetItemAsStringAsync("jwt_token", content.Value);
            _navigationManager.NavigateTo("/", true, true); // Change this to /Profile
        }
        else
        {
            _snackbar.AddErrorList(content.Errors.Values);
        }
    }
}
